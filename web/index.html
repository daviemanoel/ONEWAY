<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONE WAY 2025 - Evento Oficial</title>
    <link rel="stylesheet" type="text/css" href="./Css/style.css">
    <link rel="stylesheet" type="text/css" href="./Css/modal-checkout.css">
    <link rel="icon" type="image/png" href="./img/2.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Header com Navega√ß√£o Fixa -->
    <header class="navbar">
        <nav class="nav-container">
            <a href="#" class="logo">ONE WAY 2025</a>
            <ul class="nav-menu">
                <li><a href="#home" class="nav-link">In√≠cio</a></li>
                <li><a href="#minha-secao" class="nav-link">Ingressos</a></li>
                <li><a href="#sobre" class="nav-link">Sobre</a></li>
                <li><a href="#produtos" class="nav-link">Produtos</a></li>
                <li><a href="#alimentacao" class="nav-link">Alimenta√ß√£o</a></li>
                <li><a href="#faq" class="nav-link">FAQ</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <section id="home" class="section_home">
        <div style="position: relative; display: inline-block; width:100%">
            <img class="img-desktop" src="./img/One_Way_25-conv.png" alt="ONE WAY 2025 Banner" loading="eager" decoding="async">
            <img class="img-mobile" src="./img/One_Way_25-conv.png" alt="ONE WAY 2025 Mobile Banner" loading="eager" decoding="async">
        </div>
    </section>

    <section id="sobre" class="convidados">
        <div class="convidados__container">
            <div class="convidados__content">
                <h1 class="convidados__title">ONE WAY 2025</h1>
                <div class="convidados__text">
                    <p>Cremos que Deus est√° levantando uma gera√ß√£o que n√£o negocia o Caminho. Jovens apaixonados por Jesus, cheios do Esp√≠rito Santo, que desejam n√£o apenas falar sobre Ele, mas se parecer com Ele ‚Äî em car√°ter, em autoridade e em entrega.</p>
                    <p>O One Way √© mais do que um evento: √© um ajuntamento de filhos que decidiram viver para construir um lugar de habita√ß√£o para a Presen√ßa. Um povo que entende que h√° um √∫nico caminho, e que esse caminho √© suficiente.</p>
                    <p>Queremos, juntos, formar Cristo uns nos outros ‚Äî para que a paix√£o pelo evangelho se transforme em miss√£o, e a miss√£o em frutos que permane√ßam.</p>
                    <p>Porque o mundo n√£o precisa de mais entretenimento. Ele precisa de uma gera√ß√£o que conhe√ßa o Caminho.</p>
                </div>
            </div>
            <div class="convidados__image">
                <img src="./img/fundoteste.jpg" alt="ONE WAY 2025" class="convidados__img" loading="lazy" decoding="async">
            </div>
        </div>

    </section>

    <section id="produtos" class="section_products">
        <div class="products-container" id="products-container">
            <!-- Produtos ser√£o carregados dinamicamente via JavaScript -->
        </div>
    </section>

    <section id="minha-secao" class="section_date_tickets">
        <div class="table-container">
            <table class="date-tickets-table">
                <tr>
                    <td class="date-column">
                        <div class="date-header">
                            <h2>üìÖ Save the Date</h2>
                        </div>
                        <div class="date-info">
                            <div class="event-date">31 DE JULHO √Ä 02 DE AGOSTO</div>
                            <div class="event-year">2025</div>
                            <div class="event-location">
                                <div class="location-name">Mevam Franca</div>
                                <div class="location-city">Rua S√£o Paulo, 1151 - Vila Aparecida, Franca - SP</div>
                            </div>
                        </div>
                    </td>
                    <td class="tickets-column">
                        <div class="tickets-header">
                            <h2>Garanta seu ingresso</h2>
                        </div>
                        <div class="tickets-list">
                            <div class="ticket-item esgotado">
                                <span class="lote-name">Lote 1</span>
                                <span class="status">ESGOTADO</span>
                                <span class="price">---</span>
                            </div>
                            <div class="ticket-item esgotado">
                                <span class="lote-name">Lote 2</span>
                                <span class="status">ESGOTADO</span>
                                <span class="price">---</span>
                            </div>
                            <div class="ticket-item disponivel">
                                <span class="lote-name">Lote 3</span>
                                <span class="status">DISPON√çVEL</span>
                                <span class="price">R$ 170,00</span>
                                <a href="https://tiketo.com.br/evento/3063" target="_blank" class="buy-btn">Comprar</a>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </section>

    <section id="alimentacao" class="section_alimentacao">
        <div class="alimentacao-container">
            <div class="alimentacao-header">
                <h2 class="alimentacao-title">Alimenta√ß√£o do Evento</h2>
                <p class="alimentacao-subtitle">Adquira sua refei√ß√£o antecipadamente e garante sua vaga!</p>
            </div>
            <div class="meals-grid">
                <div class="meal-card" data-product-id="5" data-product-price="23.00">
                    <div class="meal-icon">üçΩÔ∏è</div>
                    <div class="meal-info">
                        <h3 class="meal-title">Almo√ßo - S√°bado</h3>
                        <p class="meal-description">Refei√ß√£o completa servida no intervalo do s√°bado</p>
                        <div class="meal-time">üìÖ 2 de Agosto ‚Ä¢ 12:00h</div>
                        
                        <div class="almoco-options">
                            <div class="menu-section">
                                <h4>Card√°pio Completo:</h4>
                                <ul class="menu-items">
                                    <li>üçö Arroz Branco</li>
                                    <li>üçó Strogonoff de Frango</li>
                                    <li>ü•î Batata Palha</li>
                                    <li>ü•ó Salada Alface</li>
                                    <li class="destaque">‚ú® √Ä vontade</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="meal-price-section">
                        <div class="meal-price">R$ 23,00</div>
                        <button class="meal-btn add-to-cart" data-product-id="5" data-meal-type="almoco">
                            Adicionar ao Carrinho
                        </button>
                    </div>
                </div>
                
                <div class="meal-card jantar-card" style="opacity: 0.8;">
                    <div class="meal-icon">üç¢</div>
                    <div class="meal-info">
                        <h3 class="meal-title">Jantar - S√°bado</h3>
                        <p class="meal-description">Espetinho Assado</p>
                        <div class="meal-time">üìÖ 2 de Agosto ‚Ä¢ 19:00h</div>
                        
                        <div class="jantar-options">
                            <div class="sabor-section">
                                <label for="sabor-espetinho">Escolha o sabor:</label>
                                <select class="custom-select" id="sabor-espetinho" onchange="updateJantarPrice()">
                                    <option value="7" data-name="Carne Bovina">Carne Bovina</option>
                                    <option value="8" data-name="Medalh√£o de Frango">Medalh√£o de Frango</option>
                                    <option value="9" data-name="Lingui√ßa">Lingui√ßa</option>
                                </select>
                            </div>
                            
                            <div class="adicional-section">
                                <div class="checkbox-group" onclick="toggleAdicional()">
                                    <div class="checkbox" id="adicional-checkbox">
                                        <span class="checkmark">‚úì</span>
                                    </div>
                                    <label>Adicional: Mandioca + Vinagrete (+R$ 3,00)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="meal-price-section">
                        <div class="price-breakdown" id="jantar-breakdown">Espetinho</div>
                        <div class="meal-price" id="jantar-price">R$ 10,00</div>
                        <button class="meal-btn" onclick="adicionarJantarAoCarrinho()">
                            Adicionar ao Carrinho
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="faq" class="saq">
        <div class="faq-container">
            <img src="./img/FAQ.png" alt="FAQ" class="faq-logo" loading="lazy" decoding="async">
            <div class="faq-grid">
                <div class="faq-item">
                    <button class="faq-question active">‚ñ∏ Quem pode participar do evento? </button>
                    <div class="faq-answer">Todos os jovens e adolecentes s√£o bem-vindos! O evento √© aberto para quem
                        deseja se
                        conectar com Deus, fazer novas amizades e viver algo especial. Mesmo que voc√™ n√£o fa√ßa parte da
                        nossa igreja, pode participar! </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏Qual o hor√°rio de in√≠cio e t√©rmino? </button>
                    <div class="faq-answer">O evento come√ßa pontualmente Quinta e Sexta √†s 19:00 e termina por volta das
                        00:00, e Sabado abrimos 08:00 e termina por volta das 21:00. Recomendamos chegar com pelo menos
                        15 minutos de anteced√™ncia para garantir seu lugar e se organizar com calma.
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏ Vai ter alimenta√ß√£o no evento?</button>
                    <div class="faq-answer">Sim! Teremos momentos de intervalo com alimenta√ß√£o dispon√≠vel. A compra da
                        alimenta√ß√£o poder√° ser feita junto com o ingresso, diretamente no site. Importante: n√£o ser√°
                        poss√≠vel adquirir almo√ßo ou jantar durante o evento.</div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏ Tem limite de idade para participar?</button>
                    <div class="faq-answer">N√£o teremos limita√ß√£o de idades para adolescentes e jovens, incluindo casais
                        casados que ainda n√£o t√™m filhos. Todos s√£o muito bem-vindos!</div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏Posso levar um amigo que n√£o √© da igreja? </button>
                    <div class="faq-answer">Claro! Voc√™ est√° mais do que convidado a trazer amigos, mesmo que eles n√£o
                        fa√ßam parte da igreja. O evento √© para todos que querem viver algo novo com Deus.
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏ Posso sair e voltar durante o evento? </button>
                    <div class="faq-answer">Pedimos que os participantes permane√ßam no local durante todo o evento para
                        garantir seguran√ßa e n√£o perder nenhuma parte da programa√ß√£o. Em casos especiais, fale com a
                        equipe respons√°vel na entrada.</div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏ Pode tirar fotos e postar nas redes sociais?</button>
                    <div class="faq-answer">Sim! Amamos ver voc√™s registrando e compartilhando os momentos especiais. S√≥
                        pedimos que respeite os outros participantes ao tirar fotos e que marque nosso perfil oficial
                        nas redes sociais! </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏ Vai ter algum tipo de roupa espec√≠fica ou dress code? </button>
                    <div class="faq-answer">N√£o temos um dress code obrigat√≥rio, mas recomendamos roupas confort√°veis e
                        modestas, adequadas para momentos de adora√ß√£o, din√¢micas e comunh√£o. Pedimos apenas que todos
                        usem roupas apropriadas para o ambiente, respeitando os demais participantes do evento.
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏ Quem eu posso procurar se tiver d√∫vidas no dia do evento? </button>
                    <div class="faq-answer">Durante o evento, teremos uma equipe identificada com crach√°s ou camisetas
                        da organiza√ß√£o que estar√° dispon√≠vel para te ajudar com qualquer d√∫vida. Procure por algu√©m da
                        equipe de recep√ß√£o ou v√° at√© o ponto de apoio na entrada ‚Äî estaremos prontos pra te atender!
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">‚ñ∏ Preciso levar meu documento ou comprovante de inscri√ß√£o? </button>
                    <div class="faq-answer">Sim, √© importante levar um documento com foto e, se tiver feito inscri√ß√£o
                        online, apresentar o comprovante (impresso ou no celular). Isso ajuda a agilizar sua entrada e
                        garante que tudo ocorra com seguran√ßa¬†e¬†organiza√ß√£o.
                    </div>
                </div>
            </div>
        </div>
    </section>


    <section>
        <div class="div_rodape">
            <img src="./img/rodape.png" alt="" loading="lazy" decoding="async">
        </div>
    </section>

    <script>
        // Menu hamb√∫rguer
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        });

        // Fechar menu ao clicar em um link
        document.querySelectorAll('.nav-link').forEach(n => n.addEventListener('click', () => {
            hamburger.classList.remove('active');
            navMenu.classList.remove('active');
        }));

        // Navega√ß√£o suave
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // FAQ functionality
        const buttons = document.querySelectorAll('.faq-question');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => {
                    if (b !== btn) {
                        b.classList.remove('active');
                        b.nextElementSibling.classList.remove('show');
                        b.innerText = b.innerText.replace('‚ñ¥', '‚ñ∏');
                    }
                });

                btn.classList.toggle('active');
                const answer = btn.nextElementSibling;
                answer.classList.toggle('show');
                btn.innerText = btn.classList.contains('active')
                    ? btn.innerText.replace('‚ñ∏', '‚ñ¥')
                    : btn.innerText.replace('‚ñ¥', '‚ñ∏');
            });
        });

        // Fun√ß√£o para comprar camiseta
        function comprarCamiseta() {
            const sizeSelected = document.querySelector('input[name="camiseta-size"]:checked');
            if (sizeSelected) {
                const size = sizeSelected.value;
                window.open('https://buy.stripe.com/dRm4gz0bG2B96sFbtu18c00', '_blank');
            } else {
                alert('Por favor, selecione um tamanho antes de continuar.');
            }
        }

        // Navbar transparente ao rolar
        window.addEventListener('scroll', () => {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 100) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        
        // Funcionalidade dos bot√µes de tamanho
        function initSizeButtons() {
            document.querySelectorAll('.size-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active de todos os bot√µes do mesmo produto
                    const parentSelector = this.closest('.size-selector');
                    parentSelector.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
                    // Adiciona active no clicado
                    this.classList.add('active');
                    
                });
            });
            
            // DESABILITADO: Event listener antigo dos bot√µes
            // Agora usando sistema de carrinho
            /*
            document.querySelectorAll('.product-btn').forEach(button => {
                button.addEventListener('click', function() {
                    
                    // Redirecionar para o site de compras
                    window.open('https://tiketo.com.br/evento/3063', '_blank');
                });
            });
            */
        }

        // Vari√°veis globais
        let paymentConfig = {
            cartao: 'PAYPAL',
            pix: 'MERCADOPAGO'
        };
        
        // Dados dos produtos (global para o carrinho)
        let productsData = null;
        
        // Detectar se est√° rodando em file:// (desenvolvimento local)
        const isFileProtocol = window.location.protocol === 'file:';
        
        // Dados de fallback para desenvolvimento local
        const fallbackProductsData = {
            "products": {
                "camiseta-marrom": {
                    "id": "1",
                    "title": "Camiseta One Way Marrom",
                    "price": 120.00,
                    "preco_custo": 53.50,
                    "image": "./img/camisetas/camiseta_marrom.jpeg",
                    "images": ["./img/camisetas/camiseta_marrom.jpeg", "./img/camisetas/camiseta_marrom-2.jpeg"],
                    "video": "./videos/camiseta-marrom-preview.mp4",
                    "sizes": {
                        "P": {"product_size_id": 1, "available": true, "qtda_estoque": 8, "stripe_link": null, "id_stripe": "price_1"},
                        "M": {"product_size_id": 2, "available": true, "qtda_estoque": 17, "stripe_link": null, "id_stripe": "price_2"},
                        "G": {"product_size_id": 3, "available": true, "qtda_estoque": 17, "stripe_link": null, "id_stripe": "price_3"},
                        "GG": {"product_size_id": 4, "available": true, "qtda_estoque": 7, "stripe_link": null, "id_stripe": "price_4"}
                    }
                },
                "camiseta-jesus": {
                    "id": "2",
                    "title": "Camiseta Jesus",
                    "price": 120.00,
                    "preco_custo": 55.00,
                    "image": "./img/camisetas/Camiseta_jesus.jpeg",
                    "sizes": {
                        "P": {"product_size_id": 5, "available": true, "qtda_estoque": 5, "stripe_link": null, "id_stripe": "price_5"},
                        "M": {"product_size_id": 6, "available": true, "qtda_estoque": 10, "stripe_link": null, "id_stripe": "price_6"},
                        "G": {"product_size_id": 7, "available": true, "qtda_estoque": 10, "stripe_link": null, "id_stripe": "price_7"},
                        "GG": {"product_size_id": 8, "available": true, "qtda_estoque": 4, "stripe_link": null, "id_stripe": "price_8"}
                    }
                },
                "camiseta-oneway-branca": {
                    "id": "3",
                    "title": "Camiseta ONE WAY Off White",
                    "price": 120.00,
                    "preco_custo": 51.50,
                    "image": "./img/camisetas/Camiseta_onewayBranca.jpeg",
                    "sizes": {
                        "P": {"product_size_id": 9, "available": true, "qtda_estoque": 5, "stripe_link": null, "id_stripe": "price_9"},
                        "M": {"product_size_id": 10, "available": true, "qtda_estoque": 10, "stripe_link": null, "id_stripe": "price_10"},
                        "G": {"product_size_id": 11, "available": true, "qtda_estoque": 10, "stripe_link": null, "id_stripe": "price_11"},
                        "GG": {"product_size_id": 12, "available": true, "qtda_estoque": 5, "stripe_link": null, "id_stripe": "price_12"}
                    }
                },
                "camiseta-the-way": {
                    "id": "4",
                    "title": "Camiseta The Way",
                    "price": 120.00,
                    "preco_custo": 49.50,
                    "image": "./img/camisetas/Camiseta_theway.jpeg",
                    "sizes": {
                        "P": {"product_size_id": 13, "available": true, "qtda_estoque": 5, "stripe_link": null, "id_stripe": "price_13"},
                        "M": {"product_size_id": 14, "available": true, "qtda_estoque": 10, "stripe_link": null, "id_stripe": "price_14"},
                        "G": {"product_size_id": 15, "available": true, "qtda_estoque": 10, "stripe_link": null, "id_stripe": "price_15"},
                        "GG": {"product_size_id": 16, "available": true, "qtda_estoque": 5, "stripe_link": null, "id_stripe": "price_16"}
                    }
                },
                "almoco-sabado": {
                    "id": "5",
                    "title": "üçΩÔ∏è Almo√ßo - S√°bado",
                    "price": 23.00,
                    "preco_custo": 15.00,
                    "image": "./img/2.png",
                    "sizes": {
                        "UNICO": {"product_size_id": 17, "available": true, "qtda_estoque": 300, "stripe_link": null, "id_stripe": "price_17"}
                    }
                },
                "jantar-sabado": {
                    "id": "6",
                    "title": "üçõ Jantar - S√°bado",
                    "price": 13.00,
                    "preco_custo": 11.00,
                    "image": "./img/2.png",
                    "sizes": {
                        "UNICO": {"product_size_id": 18, "available": true, "qtda_estoque": 350, "stripe_link": null, "id_stripe": "price_18"}
                    }
                },
                "espetinho-carne": {
                    "id": "7",
                    "title": "Espetinho de Carne Bovina",
                    "price": 10.00,
                    "preco_custo": 6.50,
                    "image": "./img/2.png",
                    "sizes": {
                        "UNICO": {"product_size_id": 19, "available": true, "qtda_estoque": 200, "stripe_link": null, "id_stripe": "price_espetinho_carne_001"}
                    }
                },
                "espetinho-frango": {
                    "id": "8",
                    "title": "Espetinho Medalh√£o de Frango",
                    "price": 10.00,
                    "preco_custo": 5.50,
                    "image": "./img/2.png",
                    "sizes": {
                        "UNICO": {"product_size_id": 20, "available": true, "qtda_estoque": 200, "stripe_link": null, "id_stripe": "price_espetinho_frango_001"}
                    }
                },
                "espetinho-linguica": {
                    "id": "9",
                    "title": "Espetinho de Lingui√ßa",
                    "price": 10.00,
                    "preco_custo": 5.00,
                    "image": "./img/2.png",
                    "sizes": {
                        "UNICO": {"product_size_id": 21, "available": true, "qtda_estoque": 200, "stripe_link": null, "id_stripe": "price_espetinho_linguica_001"}
                    }
                },
                "adicional-mandioca": {
                    "id": "10",
                    "title": "Adicional: Mandioca + Vinagrete",
                    "price": 3.00,
                    "preco_custo": 1.50,
                    "image": "./img/2.png",
                    "sizes": {
                        "UNICO": {"product_size_id": 22, "available": true, "qtda_estoque": 400, "stripe_link": null, "id_stripe": "price_adicional_mandioca_001"}
                    }
                }
            }
        };

        // Carregar configura√ß√£o de pagamentos
        async function loadPaymentConfig() {
            try {
                const response = await fetch('/api/payment-config');
                const data = await response.json();
                paymentConfig = data.config;
                console.log('üîß Configura√ß√£o de pagamentos carregada:', paymentConfig);
                return paymentConfig;
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√£o de pagamentos:', error);
                console.log('‚ö†Ô∏è Usando configura√ß√£o padr√£o:', paymentConfig);
                return paymentConfig;
            }
        }

        // Carregar produtos do JSON
        async function loadProducts() {
            try {
                // Carregar configura√ß√£o de pagamentos primeiro
                await loadPaymentConfig();
                
                let data;
                
                if (isFileProtocol) {
                    // Modo de desenvolvimento local - usar dados fallback
                    console.log('üîß Modo desenvolvimento detectado (file://). Usando dados fallback.');
                    data = fallbackProductsData;
                } else {
                    // Modo produ√ß√£o - carregar do servidor
                    console.log('üåê Modo produ√ß√£o detectado. Carregando products.json...');
                    const response = await fetch('./products.json');
                    data = await response.json();
                }
                
                // Armazenar dados globalmente para o carrinho
                productsData = data;
                console.log('üì¶ Dados dos produtos carregados:', productsData);
                
                // Converter objeto em array, filtrar apenas camisetas (produtos com tamanhos P,M,G,GG) e ordenar por ID
                console.log('üîç Total produtos encontrados:', Object.keys(data.products).length);
                
                const allProducts = Object.values(data.products);
                console.log('üîç Produtos antes do filtro:', allProducts.map(p => `${p.title} (ID: ${p.id})`));
                
                const productsArray = allProducts
                    .filter(product => {
                        const hasValidSizes = product.sizes && (product.sizes.P || product.sizes.M || product.sizes.G || product.sizes.GG);
                        console.log(`üîç ${product.title}: tem tamanhos v√°lidos? ${hasValidSizes}`);
                        return hasValidSizes;
                    })
                    .sort((a, b) => parseInt(a.id) - parseInt(b.id));
                
                console.log('üîç Produtos ap√≥s filtro:', productsArray.map(p => `${p.title} (ID: ${p.id})`));
                
                const container = document.getElementById('products-container');
                container.innerHTML = '';
                
                if (productsArray.length === 0) {
                    console.error('‚ùå Nenhum produto encontrado ap√≥s filtro!');
                    container.innerHTML = '<p>Nenhum produto dispon√≠vel no momento.</p>';
                    return;
                }
                
                productsArray.forEach(product => {
                    const hasVideo = product.video && product.video !== '';
                    const hasMultipleImages = product.images && product.images.length > 1;
                    const images = hasMultipleImages ? product.images : [product.image];
                    
                    // Criar array de items incluindo v√≠deo se existir
                    const mediaItems = [...images];
                    if (hasVideo) {
                        mediaItems.push(product.video);
                    }
                    
                    const hasGallery = mediaItems.length > 1;
                    
                    const productHTML = `
                        <div class="product-card" data-product-id="${product.id}" data-product-price="${product.price}">
                            <div class="product-image ${hasGallery ? 'has-gallery' : ''}">
                                ${mediaItems.map((item, index) => {
                                    const isVideo = item.includes('.mp4');
                                    if (isVideo) {
                                        return `<video class="product-video ${index === 0 ? 'active' : ''}" 
                                                       muted loop playsinline preload="metadata" 
                                                       data-media-index="${index}">
                                                    <source src="${item}" type="video/mp4">
                                                </video>`;
                                    } else {
                                        return `<img src="${item}" alt="${product.title}" loading="lazy" decoding="async" 
                                                     class="product-img ${index === 0 ? 'active' : ''}" 
                                                     data-media-index="${index}">`;
                                    }
                                }).join('')}
                                ${hasGallery ? `
                                    <div class="image-dots">
                                        ${mediaItems.map((item, index) => {
                                            const isVideo = item.includes('.mp4');
                                            return `<span class="dot ${index === 0 ? 'active' : ''}" 
                                                          data-media-index="${index}" 
                                                          data-is-video="${isVideo}">
                                                        ${isVideo ? '‚ñ∂' : ''}
                                                    </span>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="product-info">
                                <h3>${product.title}</h3>
                                <div class="product-price">R$ ${product.price.toFixed(2).replace('.', ',')}</div>
                                <div class="pix-price">PIX: R$ ${(product.price * 0.95).toFixed(2).replace('.', ',')} <span class="discount-label">(5% OFF)</span></div>
                                <div class="size-selector">
                                    <div class="size-options">
                                        ${Object.entries(product.sizes).map(([size, sizeData]) => {
                                            const isAvailable = sizeData.available;
                                            const isActive = size === 'M' && isAvailable;
                                            const disabled = !isAvailable ? 'disabled' : '';
                                            const activeClass = isActive ? 'active' : '';
                                            return `<button class="size-btn ${activeClass}" data-size="${size}" data-stripe-id="${sizeData.id_stripe}" data-product-size-id="${sizeData.product_size_id || ''}" ${disabled}>${size}</button>`;
                                        }).join('')}
                                    </div>
                                </div>
                                ${(() => {
                                    const hasAvailableSize = Object.values(product.sizes).some(sizeData => sizeData.available);
                                    const buttonClass = hasAvailableSize ? "product-btn add-to-cart" : "product-btn add-to-cart disabled";
                                    const buttonText = hasAvailableSize ? "Adicionar ao Carrinho" : "Produto Indispon√≠vel";
                                    const disabled = hasAvailableSize ? "" : "disabled";
                                    return `<button class="${buttonClass}" data-product-id="${product.id}" ${disabled}>${buttonText}</button>`;
                                })()}
                            </div>
                        </div>
                    `;
                    container.innerHTML += productHTML;
                });
                
                // Reinicializar funcionalidades ap√≥s carregar produtos
                initSizeButtons();
                initImageGallery();
                
                // Inicializar carrinho ap√≥s produtos carregarem
                initializeCartAfterProducts();
                
                // Atualizar bot√µes de alimenta√ß√£o baseado na disponibilidade
                updateMealButtons(data);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                console.error('‚ùå Stack trace:', error.stack);
                console.error('‚ùå Dados carregados:', productsData);
                
                let errorMessage = '';
                let errorDetails = '';
                
                if (isFileProtocol) {
                    errorMessage = 'Erro de desenvolvimento local detectado';
                    errorDetails = `
                        <p><strong>üîß Modo Desenvolvimento Local</strong></p>
                        <p>Voc√™ est√° abrindo o arquivo diretamente no navegador (file://)</p>
                        <p><strong>Para testar corretamente:</strong></p>
                        <ol style="text-align: left; display: inline-block;">
                            <li>Use um servidor local: <code>python -m http.server 8000</code></li>
                            <li>Ou acesse: <a href="https://oneway.mevamfranca.com.br" target="_blank">oneway.mevamfranca.com.br</a></li>
                        </ol>
                        <p style="font-size: 0.9em; color: #888;">Os dados de fallback deveriam funcionar, mas algo deu errado.</p>
                    `;
                } else {
                    errorMessage = 'Erro ao carregar produtos do servidor';
                    errorDetails = `
                        <p>Erro: ${error.message}</p>
                        <p>Verifique sua conex√£o com a internet ou tente novamente.</p>
                    `;
                }
                
                // Fallback: mostrar mensagem de erro
                document.getElementById('products-container').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666; max-width: 500px; margin: 0 auto;">
                        <h3>${errorMessage}</h3>
                        ${errorDetails}
                        <button onclick="loadProducts()" style="margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Funcionalidade dos bot√µes de tamanho (atualizada)
        function initSizeButtons() {
            document.querySelectorAll('.size-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    // Remove active de todos os bot√µes do mesmo produto
                    const parentSelector = this.closest('.size-selector');
                    parentSelector.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
                    // Adiciona active no clicado
                    this.classList.add('active');
                    
                });
            });
            
            // DESABILITADO: Event listener antigo de dual payment
            // Agora usando sistema de carrinho
            /*
            document.querySelectorAll('.product-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    
                    // Pegar tamanho selecionado
                    const productCard = this.closest('.product-card');
                    const selectedSizeBtn = productCard.querySelector('.size-btn.active');
                    const productId = this.dataset.productId;
                    const paymentMethod = productCard.querySelector('.payment-method').value;
                    
                    if (!selectedSizeBtn) {
                        alert('Por favor, selecione um tamanho dispon√≠vel.');
                        return;
                    }
                    
                    const size = selectedSizeBtn.dataset.size;
                    const priceId = selectedSizeBtn.dataset.stripeId;
                    const productName = productCard.querySelector('h3').textContent;
                    const productPrice = parseFloat(productCard.dataset.productPrice);
                    
                    if (!priceId || priceId === 'null') {
                        alert('Tamanho indispon√≠vel para compra.');
                        return;
                    }
                    
                    // Desabilitar bot√£o durante processamento
                    this.disabled = true;
                    this.textContent = 'Processando...';
                    
                    try {
                        // Abrir modal de dados do comprador
                        openCheckoutModal({
                            productId: productId,
                            priceId: priceId,
                            productName: productName,
                            size: size,
                            paymentMethod: paymentMethod,
                            installments: paymentMethod === 'pix' ? 1 : (paymentMethod === 'cartao' ? 1 : parseInt(paymentMethod)),
                            price: productPrice // S√≥ para exibi√ß√£o no modal - backend ignora
                        });
                    } catch (error) {
                        console.error('Erro ao abrir checkout:', error);
                        alert('Erro ao abrir formul√°rio. Tente novamente.');
                    } finally {
                        // Restaurar bot√£o
                        this.disabled = false;
                        this.textContent = 'Adicionar ao Carrinho';
                    }
                });
            });
            */
        }


        // Fun√ß√£o para controlar galeria unificada (imagens + v√≠deo)
        function initImageGallery() {
            document.querySelectorAll('.product-image.has-gallery').forEach(container => {
                const dots = container.querySelectorAll('.dot');
                const images = container.querySelectorAll('.product-img');
                const videos = container.querySelectorAll('.product-video');
                const allMedia = container.querySelectorAll('[data-media-index]');
                
                dots.forEach(dot => {
                    dot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const mediaIndex = parseInt(dot.dataset.mediaIndex);
                        const isVideo = dot.dataset.isVideo === 'true';
                        
                        // Remove active de todos
                        dots.forEach(d => d.classList.remove('active'));
                        allMedia.forEach(media => {
                            media.classList.remove('active');
                            // Parar v√≠deos que n√£o est√£o ativos
                            if (media.tagName === 'VIDEO') {
                                media.pause();
                                media.currentTime = 0;
                            }
                        });
                        
                        // Adiciona active no selecionado
                        dot.classList.add('active');
                        allMedia[mediaIndex].classList.add('active');
                        
                        // Se for v√≠deo, reproduzir
                        if (isVideo && allMedia[mediaIndex].tagName === 'VIDEO') {
                            allMedia[mediaIndex].play().catch(e => console.log('Video play failed:', e));
                        }
                    });
                });
            });
        }

        // ========== MODAL DE CHECKOUT ==========
        let currentCheckoutData = null;

        function openCheckoutModal(checkoutData) {
            currentCheckoutData = checkoutData;
            
            // Usar o pre√ßo real do produto
            let amount = checkoutData.price || 120.00;
            if (checkoutData.paymentMethod === 'pix') {
                amount = amount * 0.95; // 5% de desconto
            }
            
            // Preencher resumo do pedido
            document.getElementById('product-summary-text').textContent = 
                `${checkoutData.productName} - Tamanho ${checkoutData.size}`;
                
            const paymentMethodText = checkoutData.paymentMethod === 'pix' 
                ? 'PIX (5% de desconto)' 
                : 'Cart√£o de Cr√©dito';
                    
            document.getElementById('price-summary-text').innerHTML = 
                checkoutData.paymentMethod === 'pix' 
                    ? `<s>R$ 120,00</s> R$ ${amount.toFixed(2)} (${paymentMethodText})`
                    : `R$ ${amount.toFixed(2)} (${paymentMethodText})`;
            
            // Limpar formul√°rio
            document.getElementById('checkout-form').reset();
            clearErrors();
            
            // Mostrar modal
            document.getElementById('checkout-modal').style.display = 'block';
        }

        function closeCheckoutModal() {
            document.getElementById('checkout-modal').style.display = 'none';
            currentCheckoutData = null;
        }

        // Valida√ß√£o de campos
        function validateField(field) {
            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';

            switch(field.type) {
                case 'text':
                    if (value.length < 2) {
                        isValid = false;
                        errorMessage = 'Nome deve ter pelo menos 2 caracteres';
                    }
                    break;
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        isValid = false;
                        errorMessage = 'Digite um e-mail v√°lido';
                    }
                    break;
                case 'tel':
                    const phoneRegex = /^\(\d{2}\)\s\d{4,5}-\d{4}$/;
                    if (!phoneRegex.test(value)) {
                        isValid = false;
                        errorMessage = 'Use o formato: (11) 99999-9999';
                    }
                    break;
            }

            showFieldError(field, isValid, errorMessage);
            return isValid;
        }

        function showFieldError(field, isValid, errorMessage) {
            const formGroup = field.closest('.form-group');
            let errorElement = formGroup.querySelector('.error-message');
            
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                formGroup.appendChild(errorElement);
            }

            if (isValid) {
                field.classList.remove('error');
                errorElement.style.display = 'none';
            } else {
                field.classList.add('error');
                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
            }
        }

        function clearErrors() {
            document.querySelectorAll('.form-group input').forEach(input => {
                input.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.style.display = 'none';
            });
        }

        // M√°scara de telefone
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length >= 10) {
                value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (value.length >= 6) {
                value = value.replace(/(\d{2})(\d{4})/, '($1) $2');
            } else if (value.length >= 2) {
                value = value.replace(/(\d{2})/, '($1) ');
            }
            input.value = value;
        }

        // Processar checkout final
        async function processCheckout(formData) {
            if (!currentCheckoutData) return;

            const checkoutButton = document.querySelector('.confirm-btn');
            checkoutButton.disabled = true;
            checkoutButton.textContent = 'Processando...';

            try {
                // Determinar qual endpoint usar baseado na configura√ß√£o din√¢mica
                let endpoint;
                let paymentProvider;
                
                if (currentCheckoutData.paymentMethod === 'pix') {
                    // PIX sempre usa o provedor configurado (geralmente Mercado Pago)
                    if (paymentConfig.pix === 'MERCADOPAGO') {
                        endpoint = '/create-mp-checkout';
                        paymentProvider = 'Mercado Pago';
                    } else {
                        throw new Error('PIX n√£o suportado pelo provedor configurado');
                    }
                } else if (currentCheckoutData.paymentMethod === 'cartao') {
                    // Cart√£o usa o provedor configurado (PayPal ou Mercado Pago)
                    if (paymentConfig.cartao === 'PAYPAL') {
                        endpoint = '/create-paypal-order';
                        paymentProvider = 'PayPal';
                    } else if (paymentConfig.cartao === 'MERCADOPAGO') {
                        endpoint = '/create-mp-checkout';
                        paymentProvider = 'Mercado Pago';
                    } else {
                        throw new Error('Provedor de cart√£o n√£o configurado');
                    }
                } else {
                    throw new Error('M√©todo de pagamento inv√°lido');
                }

                console.log(`üîÑ Processando com ${paymentProvider}... (configura√ß√£o: ${JSON.stringify(paymentConfig)})`);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...currentCheckoutData,
                        // Dados do comprador
                        nome: formData.get('nome'),
                        email: formData.get('email'),
                        telefone: formData.get('telefone')
                    })
                });
                
                const data = await response.json();
                
                if (data.checkout_url || data.approval_url) {
                    // Fechar modal e redirecionar para o checkout
                    closeCheckoutModal();
                    const redirectUrl = data.checkout_url || data.approval_url;
                    console.log(`‚úÖ Redirecionando para ${paymentProvider}:`, redirectUrl);
                    window.location.href = redirectUrl;
                } else {
                    throw new Error(data.error || 'Erro ao processar pagamento');
                }
            } catch (error) {
                console.error('Erro no checkout:', error);
                
                // Verificar se √© erro de token
                if (error.message.includes('invalid_token') || error.message.includes('bad_request')) {
                    alert('‚ö†Ô∏è Sistema em modo de desenvolvimento\n\nPara testar com pagamento real, configure um token v√°lido.\n\nOs dados do pedido foram salvos com sucesso no sistema!');
                } else {
                    alert('Erro ao processar pagamento. Tente novamente.');
                }
            } finally {
                checkoutButton.disabled = false;
                checkoutButton.textContent = 'Confirmar e Pagar';
            }
        }

        // Inicializar quando p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();

            // Event listeners do modal
            document.querySelector('.close').addEventListener('click', closeCheckoutModal);
            document.querySelector('.cancel-btn').addEventListener('click', closeCheckoutModal);
            
            // Fechar modal clicando fora
            window.addEventListener('click', (event) => {
                const modal = document.getElementById('checkout-modal');
                if (event.target === modal) {
                    closeCheckoutModal();
                }
            });

            // Valida√ß√£o em tempo real
            document.getElementById('nome').addEventListener('blur', function() {
                validateField(this);
            });

            document.getElementById('email').addEventListener('blur', function() {
                validateField(this);
            });

            document.getElementById('telefone').addEventListener('input', function() {
                formatPhone(this);
            });

            document.getElementById('telefone').addEventListener('blur', function() {
                validateField(this);
            });

            // Submit do formul√°rio
            document.getElementById('checkout-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validar todos os campos
                const fields = this.querySelectorAll('input[required]');
                let allValid = true;
                
                fields.forEach(field => {
                    if (!validateField(field)) {
                        allValid = false;
                    }
                });

                if (allValid) {
                    const formData = new FormData(this);
                    
                    // Verificar se h√° itens no carrinho
                    if (cart && cart.items.length > 0) {
                        // Usar checkout do carrinho
                        cart.processCartCheckout(formData);
                    } else {
                        // Usar checkout individual (legado)
                        processCheckout(formData);
                    }
                } else {
                    alert('Por favor, corrija os erros no formul√°rio.');
                }
            });
        });

        // ========================================
        // SISTEMA DE CARRINHO DE COMPRAS
        // ========================================

        class ShoppingCart {
            constructor() {
                this.items = [];
                this.loadFromStorage();
                this.initEventListeners();
                this.updateUI();
            }

            // Adicionar item ao carrinho
            addItem(productId, size, productSizeId = null) {
                // Verificar se productsData foi carregado
                if (!productsData || !productsData.products) {
                    console.error('‚ùå Dados dos produtos n√£o carregados ainda. Tente novamente em alguns segundos.');
                    alert('Dados dos produtos ainda n√£o foram carregados. Tente novamente em alguns segundos.');
                    return false;
                }
                
                // Buscar produto pelo ID dentro do objeto products
                let product = null;
                
                for (const [key, prod] of Object.entries(productsData.products)) {
                    if (prod.id === productId) {
                        product = prod;
                        break;
                    }
                }
                
                if (!product) {
                    console.error('Produto n√£o encontrado:', productId);
                    return false;
                }

                // Obter product_size_id se n√£o foi fornecido
                if (!productSizeId && product.sizes[size]) {
                    productSizeId = product.sizes[size].product_size_id;
                }

                // Verificar se j√° existe o mesmo produto/tamanho
                const existingItemIndex = this.items.findIndex(
                    item => item.productId === productId && item.size === size
                );

                if (existingItemIndex >= 0) {
                    // Incrementar quantidade
                    this.items[existingItemIndex].quantity += 1;
                } else {
                    // Adicionar novo item
                    this.items.push({
                        productId: productId,
                        title: product.title,
                        size: size,
                        quantity: 1,
                        price: product.price,
                        image: product.image,
                        product_size_id: productSizeId // ‚ú® NOVO CAMPO
                    });
                }

                this.saveToStorage();
                this.updateUI();
                this.showAddedNotification(product.title, size);
                this.openPanel(); // Abrir carrinho automaticamente
                return true;
            }

            // Remover item do carrinho
            removeItem(index) {
                if (index >= 0 && index < this.items.length) {
                    this.items.splice(index, 1);
                    this.saveToStorage();
                    this.updateUI();
                }
            }

            // Atualizar quantidade de um item
            updateQuantity(index, newQuantity) {
                if (index >= 0 && index < this.items.length) {
                    if (newQuantity <= 0) {
                        this.removeItem(index);
                    } else {
                        this.items[index].quantity = newQuantity;
                        this.saveToStorage();
                        this.updateUI();
                    }
                }
            }

            // Calcular total
            getTotal() {
                return this.items.reduce((total, item) => {
                    return total + (item.price * item.quantity);
                }, 0);
            }

            // Calcular total com desconto PIX
            getPixTotal() {
                return this.getTotal() * 0.95;
            }

            // Obter quantidade total de itens
            getTotalItems() {
                return this.items.reduce((total, item) => total + item.quantity, 0);
            }

            // Limpar carrinho
            clear() {
                this.items = [];
                this.saveToStorage();
                this.updateUI();
            }

            // Salvar no localStorage
            saveToStorage() {
                try {
                    localStorage.setItem('oneway_cart', JSON.stringify(this.items));
                } catch (error) {
                    console.error('Erro ao salvar carrinho:', error);
                }
            }

            // Carregar do localStorage
            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('oneway_cart');
                    if (saved) {
                        this.items = JSON.parse(saved);
                        // Migrar itens antigos sem product_size_id
                        this.migrateOldItems();
                    }
                } catch (error) {
                    console.error('Erro ao carregar carrinho:', error);
                    this.items = [];
                }
            }

            // Migrar itens antigos para incluir product_size_id
            migrateOldItems() {
                let needsSave = false;
                
                this.items.forEach(item => {
                    if (!item.product_size_id && productsData && productsData.products) {
                        // Buscar product_size_id baseado no productId e size
                        for (const [key, product] of Object.entries(productsData.products)) {
                            if (product.id === item.productId && product.sizes[item.size]) {
                                item.product_size_id = product.sizes[item.size].product_size_id;
                                needsSave = true;
                                console.log(`üîÑ Migrado item: ${item.title} ${item.size} -> ID ${item.product_size_id}`);
                                break;
                            }
                        }
                    }
                });
                
                if (needsSave) {
                    this.saveToStorage();
                    console.log('‚úÖ Carrinho migrado com product_size_id');
                }
            }

            // Atualizar interface
            updateUI() {
                this.updateCartCount();
                this.updateCartPanel();
                this.updateCartFooter();
            }

            // Atualizar contador do √≠cone
            updateCartCount() {
                const countElement = document.querySelector('.cart-count');
                const totalItems = this.getTotalItems();
                if (countElement) {
                    countElement.textContent = totalItems;
                    countElement.style.display = totalItems > 0 ? 'flex' : 'none';
                }
            }

            // Atualizar painel do carrinho
            updateCartPanel() {
                const cartItemsContainer = document.getElementById('cart-items');
                if (!cartItemsContainer) return;

                if (this.items.length === 0) {
                    cartItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7ZM9 3V4H15V3H9ZM7 6V19H17V6H7Z"/>
                            </svg>
                            <h3>Carrinho vazio</h3>
                            <p>Adicione produtos ao seu carrinho para continuar</p>
                        </div>
                    `;
                } else {
                    cartItemsContainer.innerHTML = this.items.map((item, index) => `
                        <div class="cart-item">
                            <img src="${item.image}" alt="${item.title}" class="cart-item-image">
                            <div class="cart-item-details">
                                <div class="cart-item-title">${item.title}</div>
                                <div class="cart-item-info">Tamanho: ${item.size}</div>
                                <div class="cart-item-controls">
                                    <div class="quantity-controls">
                                        <button class="quantity-btn" onclick="cart.updateQuantity(${index}, ${item.quantity - 1})">-</button>
                                        <span class="quantity-value">${item.quantity}</span>
                                        <button class="quantity-btn" onclick="cart.updateQuantity(${index}, ${item.quantity + 1})">+</button>
                                    </div>
                                    <button class="remove-item" onclick="cart.removeItem(${index})" title="Remover item">üóëÔ∏è</button>
                                </div>
                                <div class="cart-item-price">R$ ${(item.price * item.quantity).toFixed(2).replace('.', ',')}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // Atualizar footer do carrinho
            updateCartFooter() {
                const totalElement = document.getElementById('cart-total');
                const pixTotalElement = document.getElementById('cart-pix-total');
                const checkoutBtn = document.getElementById('checkout-btn');
                const paymentSelect = document.getElementById('cart-payment-select');
                const paymentWarning = document.getElementById('payment-presencial-warning');

                const total = this.getTotal();
                const pixTotal = this.getPixTotal();
                const selectedMethod = paymentSelect ? paymentSelect.value : 'pix';

                if (totalElement) {
                    totalElement.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                }
                
                // Mostrar/esconder aviso de pagamento presencial
                if (paymentWarning) {
                    paymentWarning.style.display = selectedMethod === 'presencial' ? 'flex' : 'none';
                }

                if (pixTotalElement) {
                    // Mostrar/esconder linha PIX baseado na sele√ß√£o
                    const pixTotalContainer = pixTotalElement.closest('.cart-pix-total');
                    if (pixTotalContainer) {
                        if (selectedMethod === 'pix') {
                            pixTotalContainer.style.display = 'flex';
                            pixTotalElement.textContent = `R$ ${pixTotal.toFixed(2).replace('.', ',')}`;
                        } else {
                            pixTotalContainer.style.display = 'none';
                        }
                    }
                }

                if (checkoutBtn) {
                    checkoutBtn.disabled = this.items.length === 0;
                    // Atualizar texto do bot√£o com valor final
                    const finalPrice = selectedMethod === 'pix' ? pixTotal : total;
                    checkoutBtn.textContent = this.items.length === 0 ? 
                        'Finalizar Compra' : 
                        `Finalizar Compra - R$ ${finalPrice.toFixed(2).replace('.', ',')}`;
                }
            }

            // Mostrar notifica√ß√£o de item adicionado
            showAddedNotification(productTitle, size) {
                // Criar notifica√ß√£o
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                notification.innerHTML = `
                    <strong>‚úì Adicionado ao carrinho!</strong><br>
                    ${productTitle} (${size})
                `;

                document.body.appendChild(notification);

                // Animar entrada
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                // Remover ap√≥s 3 segundos
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            // Inicializar event listeners
            initEventListeners() {
                // √çcone do carrinho
                const cartIcon = document.getElementById('cart-icon');
                if (cartIcon) {
                    cartIcon.addEventListener('click', () => this.openPanel());
                }

                // Fechar carrinho
                const closeCart = document.querySelector('.close-cart');
                if (closeCart) {
                    closeCart.addEventListener('click', () => this.closePanel());
                }

                // Overlay
                const overlay = document.getElementById('cart-overlay');
                if (overlay) {
                    overlay.addEventListener('click', () => this.closePanel());
                }

                // Bot√£o de checkout
                const checkoutBtn = document.getElementById('checkout-btn');
                if (checkoutBtn) {
                    checkoutBtn.addEventListener('click', () => this.startCheckout());
                }

                // Sele√ß√£o de m√©todo de pagamento
                const paymentSelect = document.getElementById('cart-payment-select');
                if (paymentSelect) {
                    paymentSelect.addEventListener('change', () => this.updateUI());
                }

                // Link para continuar comprando
                const continueShopping = document.getElementById('continue-shopping');
                if (continueShopping) {
                    continueShopping.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.closePanel();
                        // Scroll suave para a se√ß√£o de produtos
                        const produtosSection = document.querySelector('#produtos');
                        if (produtosSection) {
                            produtosSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                }

                // Atualizar event listeners dos bot√µes de adicionar ao carrinho
                this.updateAddToCartButtons();
            }

            // Atualizar bot√µes "Adicionar ao Carrinho"
            updateAddToCartButtons() {
                const buttons = document.querySelectorAll('.add-to-cart');
                console.log(`üîß updateAddToCartButtons: Encontrados ${buttons.length} bot√µes`);
                
                buttons.forEach((button, index) => {
                    // Verificar se j√° tem o listener para evitar duplica√ß√£o
                    if (button.dataset.listenerAdded === 'true') {
                        console.log(`‚ö†Ô∏è Bot√£o ${index + 1} j√° tem listener`);
                        return;
                    }
                    
                    console.log(`üîß Processando bot√£o ${index + 1}:`, button);

                    // Adicionar listener diretamente sem clonar
                    button.addEventListener('click', (e) => {
                        console.log('üõí Bot√£o carrinho clicado!', e);
                        e.preventDefault();
                        
                        // Verificar se o bot√£o est√° desabilitado
                        if (button.disabled || button.classList.contains('disabled')) {
                            console.log('‚ö†Ô∏è Bot√£o desabilitado - produto indispon√≠vel');
                            return;
                        }
                        
                        const productCard = button.closest('.product-card');
                        const mealCard = button.closest('.meal-card');
                        const productId = button.dataset.productId || (mealCard ? mealCard.dataset.productId : null);

                        console.log('üõí Dados do clique:', { productCard, mealCard, productId });

                        let size, productSizeId;
                        
                        if (mealCard) {
                            // Produto de alimenta√ß√£o - tamanho fixo "UNICO"
                            size = 'UNICO';
                            // Buscar product_size_id do products.json
                            if (productsData && productsData.products) {
                                for (const [key, product] of Object.entries(productsData.products)) {
                                    if (product.id === productId && product.sizes['UNICO']) {
                                        productSizeId = product.sizes['UNICO'].product_size_id;
                                        break;
                                    }
                                }
                            }
                            
                            if (!productSizeId) {
                                console.error('‚ùå product_size_id n√£o encontrado para produto de alimenta√ß√£o:', productId);
                                alert('Erro ao adicionar produto. Dados n√£o carregados completamente.');
                                return;
                            }
                            
                            console.log('üçΩÔ∏è Produto de alimenta√ß√£o:', { productId, size, productSizeId });
                        } else if (productCard) {
                            // Produto com tamanhos (camisetas)
                            const selectedSizeBtn = productCard.querySelector('.size-btn.active');
                            if (!selectedSizeBtn) {
                                alert('Por favor, selecione um tamanho dispon√≠vel.');
                                return;
                            }
                            size = selectedSizeBtn.dataset.size;
                            productSizeId = selectedSizeBtn.dataset.productSizeId;
                            console.log('üëï Produto com tamanhos:', { productId, size, productSizeId });
                        } else {
                            console.error('‚ùå N√£o foi poss√≠vel identificar o tipo de produto');
                            return;
                        }
                        
                        // Anima√ß√£o do bot√£o
                        button.disabled = true;
                        const originalText = button.textContent;
                        button.textContent = 'Adicionando...';

                        // Adicionar ao carrinho
                        const success = this.addItem(productId, size, productSizeId);
                        console.log('üõí Resultado addItem:', success);
                        
                        // Restaurar bot√£o
                        setTimeout(() => {
                            button.disabled = false;
                            button.textContent = originalText;
                        }, 500);
                    });
                    
                    // Marcar que o listener foi adicionado
                    button.dataset.listenerAdded = 'true';
                    console.log(`‚úÖ Event listener adicionado ao bot√£o ${index + 1}`);
                });
            }

            // Abrir painel
            openPanel() {
                const panel = document.getElementById('cart-panel');
                const overlay = document.getElementById('cart-overlay');
                
                if (panel) panel.classList.add('open');
                if (overlay) overlay.classList.add('active');
                
                // Bloquear scroll do body
                document.body.style.overflow = 'hidden';
            }

            // Fechar painel
            closePanel() {
                const panel = document.getElementById('cart-panel');
                const overlay = document.getElementById('cart-overlay');
                
                if (panel) panel.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
                
                // Restaurar scroll do body
                document.body.style.overflow = '';
            }

            // Iniciar checkout
            startCheckout() {
                if (this.items.length === 0) {
                    alert('Carrinho vazio!');
                    return;
                }

                // Fechar painel do carrinho
                this.closePanel();

                // Atualizar resumo no modal
                this.updateCheckoutModal();

                // Abrir modal de checkout
                const modal = document.getElementById('checkout-modal');
                if (modal) {
                    modal.style.display = 'block';
                }
            }

            // Atualizar modal de checkout com os itens do carrinho
            updateCheckoutModal() {
                const summaryText = document.getElementById('product-summary-text');
                const priceText = document.getElementById('price-summary-text');

                if (summaryText) {
                    const itemsText = this.items.map(item => 
                        `${item.title} (${item.size}) x${item.quantity}`
                    ).join('<br>');
                    summaryText.innerHTML = itemsText;
                }

                if (priceText) {
                    const total = this.getTotal();
                    const pixTotal = this.getPixTotal();
                    const paymentSelect = document.getElementById('cart-payment-select');
                    const selectedMethod = paymentSelect ? paymentSelect.value : 'pix';
                    
                    if (selectedMethod === 'pix') {
                        priceText.innerHTML = `
                            <strong>Subtotal: R$ ${total.toFixed(2).replace('.', ',')}</strong><br>
                            <span style="color: #28a745; font-weight: bold;">Total PIX (5% OFF): R$ ${pixTotal.toFixed(2).replace('.', ',')}</span>
                        `;
                    } else if (selectedMethod === 'presencial') {
                        priceText.innerHTML = `
                            <strong>Total: R$ ${total.toFixed(2).replace('.', ',')}</strong><br>
                            <span style="color: #f0b429;">‚ö†Ô∏è Pagamento na secretaria da igreja</span>
                        `;
                    } else {
                        priceText.innerHTML = `
                            <strong>Total Cart√£o: R$ ${total.toFixed(2).replace('.', ',')}</strong>
                        `;
                    }
                }
            }

            // Processar checkout do carrinho
            async processCartCheckout(formData) {
                try {
                    const timestamp = new Date().toISOString();
                    console.log('üöÄ INICIANDO CHECKOUT CARRINHO:', { timestamp, totalItems: this.items.length });
                    
                    const buyer = {
                        name: formData.get('nome'),
                        email: formData.get('email'),
                        phone: formData.get('telefone')
                    };
                    console.log('üë§ DADOS COMPRADOR:', { ...buyer, emailMasked: buyer.email.replace(/(.{2}).*(@.*)/, '$1***$2') });

                    // Preparar itens do carrinho
                    const items = this.items.map(item => ({
                        productId: item.productId,
                        size: item.size,
                        quantity: item.quantity,
                        price: item.price,
                        product_size_id: item.product_size_id // ‚ú® NOVO CAMPO para Django
                    }));
                    console.log('üì¶ ITENS PREPARADOS:', items.map(item => ({
                        id: item.productId,
                        size: item.size,
                        qty: item.quantity,
                        price: `R$ ${item.price}`,
                        hasProductSizeId: !!item.product_size_id
                    })));

                    // Determinar m√©todo de pagamento baseado na sele√ß√£o do carrinho
                    const paymentSelect = document.getElementById('cart-payment-select');
                    const paymentMethod = paymentSelect ? paymentSelect.value : 'pix';
                    console.log('üí≥ M√âTODO PAGAMENTO:', { paymentMethod, total: `R$ ${this.getTotal()}`, totalPix: `R$ ${this.getPixTotal()}` });

                    console.log('üöÄ ENVIANDO REQUISI√á√ÉO CHECKOUT:', { 
                        timestamp, 
                        endpoint: '/api/cart/checkout',
                        method: 'POST',
                        buyer: { ...buyer, phone: buyer.phone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3') },
                        itemsCount: items.length,
                        paymentMethod 
                    });

                    const response = await fetch('/api/cart/checkout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            buyer: buyer,
                            items: items,
                            paymentMethod: paymentMethod
                        })
                    });

                    console.log('üì• RESPOSTA CHECKOUT:', { 
                        status: response.status, 
                        ok: response.ok, 
                        statusText: response.statusText,
                        headers: {
                            contentType: response.headers.get('content-type'),
                            contentLength: response.headers.get('content-length')
                        }
                    });

                    const data = await response.json();
                    console.log('üìã DADOS RESPOSTA:', { 
                        success: data.success, 
                        hasRedirectUrl: !!data.redirect_url,
                        hasPaymentUrl: !!data.paymentUrl,
                        hasCheckoutUrl: !!data.checkout_url,
                        hasPedidoId: !!data.pedido_id,
                        hasExternalRef: !!data.external_reference
                    });

                    if (response.ok && data.success) {
                        console.log('‚úÖ CHECKOUT SUCESSO:', { 
                            success: data.success,
                            pedidoId: data.pedido_id,
                            externalReference: data.external_reference,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Limpar carrinho
                        console.log('üßπ LIMPANDO CARRINHO:', { itemsAntes: this.items.length });
                        this.clear();
                        console.log('‚úÖ CARRINHO LIMPO');
                        
                        // Redirecionar baseado no tipo de resposta
                        if (data.redirect_url) {
                            console.log('üîÑ REDIRECIONAMENTO PRESENCIAL:', { 
                                url: data.redirect_url,
                                pedidoId: data.pedido_id,
                                externalRef: data.external_reference,
                                timestamp: new Date().toISOString()
                            });
                            window.location.href = data.redirect_url;
                        } else if (data.paymentUrl) {
                            console.log('üîÑ REDIRECIONAMENTO GATEWAY:', { 
                                provider: paymentMethod,
                                url: data.paymentUrl,
                                pedidoId: data.pedido_id,
                                externalRef: data.external_reference,
                                checkoutUrl: data.checkout_url,
                                timestamp: new Date().toISOString()
                            });
                            window.location.href = data.paymentUrl;
                        } else {
                            console.error('‚ùå URL REDIRECIONAMENTO AUSENTE:', { 
                                data,
                                hasRedirectUrl: !!data.redirect_url,
                                hasPaymentUrl: !!data.paymentUrl,
                                hasCheckoutUrl: !!data.checkout_url,
                                timestamp: new Date().toISOString()
                            });
                            alert('Erro ao processar pagamento. Tente novamente.');
                        }
                    } else {
                        console.error('‚ùå ERRO CHECKOUT:', { 
                            responseOk: response.ok,
                            dataSuccess: data.success,
                            status: response.status,
                            statusText: response.statusText,
                            error: data.error,
                            details: data.details,
                            data,
                            timestamp: new Date().toISOString()
                        });
                        alert(data.error || 'Erro ao processar checkout. Tente novamente.');
                    }

                } catch (error) {
                    console.error('‚ùå ERRO CR√çTICO CHECKOUT:', { 
                        message: error.message,
                        stack: error.stack,
                        name: error.name,
                        timestamp: new Date().toISOString(),
                        buyer,
                        items: items?.length || 0,
                        paymentMethod
                    });
                    alert('Erro de conex√£o. Verifique sua internet e tente novamente.');
                }
            }
        }

        // Inicializar carrinho
        let cart;
        
        // Inicializar carrinho quando DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar carrinho imediatamente
            if (!cart) {
                cart = new ShoppingCart();
                console.log('üõí Carrinho inicializado no DOMContentLoaded');
            }
        });
        
        // Fun√ß√£o para re-inicializar carrinho ap√≥s renderiza√ß√£o de produtos
        function initializeCartAfterProducts() {
            if (!cart) {
                cart = new ShoppingCart();
                console.log('üõí Carrinho inicializado ap√≥s produtos');
            } else {
                cart.updateAddToCartButtons();
                console.log('üõí Bot√µes do carrinho atualizados');
            }
        }
        
        function updateMealButtons(data) {
            console.log('üçΩÔ∏è Atualizando bot√µes de alimenta√ß√£o...');
            
            // Temporariamente desabilitado para permitir compras de teste
            // TODO: Reativar valida√ß√£o de estoque quando sistema estiver estabilizado
            
            /*
            // Verificar se almo√ßo est√° dispon√≠vel
            const almoco = data.products['almoco-sabado'];
            if (almoco) {
                const almocoButton = document.querySelector('[data-product-id="5"]');
                const almocoAvailable = almoco.sizes && almoco.sizes['UNICO'] && almoco.sizes['UNICO'].available;
                
                if (almocoButton) {
                    if (!almocoAvailable) {
                        almocoButton.textContent = 'Produto Indispon√≠vel';
                        almocoButton.classList.add('disabled');
                        almocoButton.disabled = true;
                        console.log('üçΩÔ∏è Almo√ßo marcado como indispon√≠vel');
                    }
                }
            }
            
            // Verificar se jantar est√° dispon√≠vel
            const jantar = data.products['jantar-sabado'];
            if (jantar) {
                const jantarButton = document.querySelector('[data-product-id="6"]');
                const jantarAvailable = jantar.sizes && jantar.sizes['UNICO'] && jantar.sizes['UNICO'].available;
                
                if (jantarButton) {
                    if (!jantarAvailable) {
                        jantarButton.textContent = 'Produto Indispon√≠vel';
                        jantarButton.classList.add('disabled');
                        jantarButton.disabled = true;
                        console.log('üçΩÔ∏è Jantar marcado como indispon√≠vel');
                    }
                }
            }
            */
            
            console.log('üçΩÔ∏è Valida√ß√£o de estoque temporariamente desabilitada');
        }

        // ========== FUN√á√ïES DO CARD DE JANTAR ==========
        let adicionalSelecionado = false;

        function toggleAdicional() {
            adicionalSelecionado = !adicionalSelecionado;
            const checkbox = document.getElementById('adicional-checkbox');
            
            if (adicionalSelecionado) {
                checkbox.classList.add('checked');
            } else {
                checkbox.classList.remove('checked');
            }
            
            updateJantarPrice();
        }

        function updateJantarPrice() {
            const basePrice = 10.00;
            const adicionalPrice = 3.00;
            let total = basePrice;
            let breakdown = 'Espetinho';
            
            if (adicionalSelecionado) {
                total += adicionalPrice;
                breakdown += ' + Mandioca + Vinagrete';
            }
            
            // Atualizar exibi√ß√£o
            document.getElementById('jantar-breakdown').textContent = breakdown;
            document.getElementById('jantar-price').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function adicionarJantarAoCarrinho() {
            if (!productsData || !productsData.products) {
                alert('Aguarde o carregamento dos produtos...');
                return;
            }

            // Obter espetinho selecionado
            const selectElement = document.getElementById('sabor-espetinho');
            const espetinhoId = selectElement.value;
            const espetinhoName = selectElement.options[selectElement.selectedIndex].getAttribute('data-name');
            
            console.log('üêõ DEBUG espetinhoId:', espetinhoId);
            console.log('üêõ DEBUG productsData:', productsData);
            console.log('üêõ DEBUG produtos dispon√≠veis:', Object.keys(productsData.products));
            
            // Buscar dados do espetinho
            let espetinhoProduct = null;
            for (const [key, product] of Object.entries(productsData.products)) {
                console.log(`üêõ DEBUG comparando: product.id="${product.id}" vs espetinhoId="${espetinhoId}"`);
                if (product.id === espetinhoId) {
                    espetinhoProduct = product;
                    break;
                }
            }
            
            if (!espetinhoProduct) {
                console.error('‚ùå Produto n√£o encontrado! espetinhoId:', espetinhoId);
                alert('Erro ao localizar produto. Tente novamente.');
                return;
            }
            
            // Adicionar espetinho ao carrinho
            const espetinhoSizeId = espetinhoProduct.sizes['UNICO'].product_size_id;
            cart.addItem(espetinhoId, 'UNICO', espetinhoSizeId);
            
            // Se adicional selecionado, adicionar tamb√©m
            if (adicionalSelecionado) {
                const adicionalProduct = productsData.products['adicional-mandioca'];
                if (adicionalProduct) {
                    const adicionalSizeId = adicionalProduct.sizes['UNICO'].product_size_id;
                    cart.addItem(adicionalProduct.id, 'UNICO', adicionalSizeId);
                }
            }
            
            // Resetar sele√ß√µes
            document.getElementById('sabor-espetinho').selectedIndex = 0;
            adicionalSelecionado = false;
            document.getElementById('adicional-checkbox').classList.remove('checked');
            updateJantarPrice();
            
            // Abrir carrinho
            cart.openPanel();
        }

    </script>

    <!-- √çcone Flutuante do Carrinho -->
    <div id="cart-icon" class="cart-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 22C9.55228 22 10 21.5523 10 21C10 20.4477 9.55228 20 9 20C8.44772 20 8 20.4477 8 21C8 21.5523 8.44772 22 9 22Z" fill="currentColor"/>
            <path d="M20 22C20.5523 22 21 21.5523 21 21C21 20.4477 20.5523 20 20 20C19.4477 20 19 20.4477 19 21C19 21.5523 19.4477 22 20 22Z" fill="currentColor"/>
            <path d="M1 1H5L7.68 14.39C7.77144 14.8504 8.02191 15.264 8.38755 15.5583C8.75318 15.8526 9.2107 16.009 9.68 16H19.4C19.8693 16.009 20.3268 15.8526 20.6925 15.5583C21.0581 15.264 21.3086 14.8504 21.4 14.39L23 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="cart-count">0</span>
    </div>

    <!-- Painel Lateral do Carrinho -->
    <div id="cart-panel" class="cart-panel">
        <div class="cart-header">
            <h2>Carrinho de Compras</h2>
            <button class="close-cart">&times;</button>
        </div>
        <div class="cart-items" id="cart-items">
            <!-- Items do carrinho ser√£o inseridos aqui dinamicamente -->
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cart-total">R$ 0,00</span>
            </div>
            <div class="cart-pix-total">
                <span>PIX (5% OFF):</span>
                <span id="cart-pix-total">R$ 0,00</span>
            </div>
            <div class="cart-payment-method">
                <label for="cart-payment-select">Forma de Pagamento:</label>
                <select id="cart-payment-select">
                    <option value="pix">PIX (5% desconto)</option>
                    <option value="credit_card">Cart√£o de Cr√©dito</option>
                    <option value="presencial">Pagamento Presencial</option>
                </select>
            </div>
            <div id="payment-presencial-warning" class="payment-warning" style="display: none;">
                <span>‚ö†Ô∏è</span>
                <p>Pagamento na secretaria da igreja em at√© 48h. Produto n√£o garantido at√© confirma√ß√£o do pagamento.</p>
            </div>
            <button class="checkout-btn" id="checkout-btn">Finalizar Compra</button>
            <a href="#produtos" class="continue-shopping-link" id="continue-shopping">Escolher outros modelos</a>
        </div>
    </div>

    <!-- Overlay para o carrinho -->
    <div id="cart-overlay" class="cart-overlay"></div>

    <!-- Modal de Dados do Comprador -->
    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Finalizar Compra</h2>
            <form id="checkout-form">
                <div class="form-group">
                    <label for="nome">Nome Completo *</label>
                    <input type="text" id="nome" name="nome" required>
                </div>
                
                <div class="form-group">
                    <label for="email">E-mail *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="telefone">Telefone/WhatsApp *</label>
                    <input type="tel" id="telefone" name="telefone" placeholder="(11) 99999-9999" required>
                </div>
                
                <div class="product-summary">
                    <h3>Resumo do Pedido:</h3>
                    <p id="product-summary-text"></p>
                    <p id="price-summary-text"></p>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn">Cancelar</button>
                    <button type="submit" class="confirm-btn">Confirmar e Pagar</button>
                </div>
            </form>
        </div>
    </div>

</body>

</html>